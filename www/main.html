<!DOCTYPE html>
<html>

<head>
    <link rel="icon" href="data:;base64,=">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        function DofY(thisDay) {
            var start = new Date(thisDay.getFullYear(), 0, 0);
            var diff = (thisDay - start) + ((start.getTimezoneOffset() - thisDay.getTimezoneOffset()) * 60 * 1000);
            var oneDay = 1000 * 60 * 60 * 24;
            var day = Math.floor(diff / oneDay);
           // console.log('Day of year: ' + day);
            return day;
        }
        function timeFormatterDiffDay (thisDay) {
            var day1 = dateFormatterD.format(thisDay);
            diff_days = DofY(thisDay)-DofY(new Date(Date.now()));
            if (diff_days < 0) {
                day1 = diff_days + ' ' + day1;
            }
            else if (diff_days > 0) {
                day1 = '+'+diff_days + ' ' + day1;
            }
            return day1;
        }
        function isUpString(up) {
            if (up) return "UP"; else return "down";
        }
        function refreshData() {
            //const options = { dateStyle : 'short', timeStyle: 'short'};
            dateFormatter = new Intl.DateTimeFormat('fi-FI', { dateStyle: 'short', timeStyle: 'medium' });
            dateFormatterD = new Intl.DateTimeFormat('fi-FI', {  timeStyle: 'medium' });


            $.getJSON("/status", function (result) {
                //$("div").innerHTML = "";
                $("div").empty();
                $("div").append("<h2>Channels</h2><ul>");
                $.each(result.channels, function (i, field) {
                    // $("div").append("<li>" + field.code + "</li>");
                    targetText = "";
                    if (field.target && field.up) {
                        if (field.target.forceOn) {
                            targetText = `, [${field.target.condition}]: always on`;      
                        }
                        else if (!field.target.reached) {
                            targetText = `, target [${field.target.condition}]: ${field.target.sersorValue} (${field.target.sensor}) => ${field.target.targetTemp}`;  
                        }
                    }
                    $("div").append(`<li>${field.code} ${field.name} ${isUpString(field.up)} ${targetText}</li>`);

                });
                $("div").append("</ul>");
                $("div").append("<h2>Sensors</h2><ul>");
                //    alert(JSON.stringify(result.sensors));
                $.each(result.sensors, function (i, field) {
                    $("div").append(`<li>${field.code} ${field.name} (${field.id}): ${field.value}</li>`);
                });
                $("div").append("</ul>");
                $("div").append("<h2>Updates</h2><ul>");
                $.each(result.updates, function (i, field) {
                  //  var updated = dateFormatterD.format(new Date(field.updated));
                    var updated = timeFormatterDiffDay(new Date(field.updated));
                    latest_ts = new Date(field.latest_ts); //Date.now()
                    var lts = dateFormatterD.format(latest_ts);
                    ts_diff_days = DofY(latest_ts)-DofY(new Date(Date.now()));
                    if (ts_diff_days < 0) {
                        lts = ts_diff_days + ' ' + lts;
                    }
                    else if (ts_diff_days > 0) {
                        lts = '+'+ts_diff_days + ' ' + lts;
                
                    }
                    $("div").append(`<li>${field.code} (${updated}): ${lts} </li>`);
                });
                $("div").append("</ul>");
                if (result.Wsys) {
                    $("div").append("Power:" + Math.round(result.Wsys) + " W <br>");  
                }
                if (result.current_conditions) {
                    $("div").append("Conditions:" + JSON.stringify(result.current_conditions) + "<br>");       
                }


 
            })
                .done(function () { })
                .fail(function (jqXHR, textStatus, errorThrown) { alert('getJSON request failed! '); alert(textStatus) })
                .always(function () { //var timeoutID = setTimeout(refreshData(),60000);
                 });
        }


        $(document).ready(function () {
            var timeoutID = setTimeout(refreshData(),10000); 
            var intervalID = setInterval(refreshData, 60000);
            $("#btn3").click(function () {refreshData()});
    
        });

    </script>
</head>

<body>

    <button id="btn3">refresh</button>

    <div></div>

</body>

</html>